package main

import (
	"context"
	"fmt"
	"log"
	"os"
	"time"

	// Import MCP plugins to enable MCP functionality
	_ "github.com/agenticgokit/agenticgokit/plugins/mcp/default"
	_ "github.com/agenticgokit/agenticgokit/plugins/mcp/unified"

	agk "github.com/agenticgokit/agenticgokit/v1beta"
)

func main() {
	ctx, cancel := context.WithTimeout(context.Background(), 120*time.Second)
	defer cancel()

	// Get service version from environment or use default
	serviceVersion := os.Getenv("SERVICE_VERSION")
	if serviceVersion == "" {
		serviceVersion = "0.1.0"
	}

	fmt.Println("Initializing Agent with MCP Tools...")

	// Create agent with MCP tools and observability
	// Tracing is enabled if AGK_TRACE=true environment variable is set
	agent, err := agk.NewBuilder("{{.ProjectName}}").

		WithObservability("{{.ProjectName}}", serviceVersion).
		WithConfig(&agk.Config{
			Name:         "{{.ProjectName}}",
			SystemPrompt: "You are a helpful assistant with access to tools. Use the available MCP tools to help the user accomplish their tasks. Always explain what tools you're using and why.",
			Timeout:      120 * time.Second,
			LLM: agk.LLMConfig{
				Provider:    "{{.LLMProvider}}",
				Model:       "{{.LLMModel}}",
				Temperature: 0.7,
				MaxTokens:   4000,
			},
			Tools: &agk.ToolsConfig{
				Enabled: true,
				// Configure MCP servers for tool access
				// MCP (Model Context Protocol) enables agents to use external tools
				MCP: &agk.MCPConfig{
					Enabled:           true,
					Discovery:         false,
					ConnectionTimeout: 10 * time.Second,
					Servers: []agk.MCPServer{
						{
							Name:    "filesystem",
							Type:    "stdio",
							// Note: The current stdio implementation does not support arguments.
							// You must point to a specific executable or a wrapper script.
							// Example: "./mcp-server-filesystem.exe" or "./run-filesystem.bat"
							Command: "npx", // Placeholder - likely needs a wrapper script
							Enabled: true,
						},
						// Example of HTTP SSE configuration (alternative to stdio)
						// {
						// 	Name:    "weather-server",
						// 	Type:    "http_sse",
						// 	Address: "http://localhost:8080",
						// 	Enabled: true,
						// },
					},
				},
			},
		}).
		Build()
	if err != nil {
		log.Fatalf("Failed to create agent: %v", err)
	}
	defer agent.Cleanup(ctx)

	// Wait for MCP servers to initialize
	fmt.Println("Initializing MCP tools...")
	time.Sleep(2 * time.Second)

	// Example: Use tools to help with a task
	userMessage := "List the files in the current directory and tell me what this project is about."

	fmt.Printf("\nUser: %s\n\n", userMessage)
	fmt.Println("Assistant:")

	// Use streaming for real-time response
	stream, err := agent.RunStream(ctx, userMessage)
	if err != nil {
		log.Fatalf("Failed to start streaming: %v", err)
	}

	printStreamingResponse(stream)
}

// printStreamingResponse prints the streaming response as tokens arrive
func printStreamingResponse(stream agk.Stream) {
	for chunk := range stream.Chunks() {
		if chunk.Error != nil {
			fmt.Printf("\nError: %v\n", chunk.Error)
			break
		}

		switch chunk.Type {
		case agk.ChunkTypeDelta:
			fmt.Print(chunk.Delta)
		case agk.ChunkTypeToolCall:
			fmt.Printf("\n[Tool Call: %s]\n", chunk.ToolName)
		case agk.ChunkTypeDone:
			fmt.Println("\n\nCompleted")
		}
	}
}
